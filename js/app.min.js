var Sms={selectedConversation:null,unreadCountCurrentConv:0,unreadCountNotifStep:12,lastContactListMsgDate:0,originalTitle:document.title,photoVersion:1,_winRegexp:/(.*)\/ocsms.*/,generateURL:function(t){var e=this._winRegexp.exec(window.location.href);return 2!==e.length&&console.log("A very bad error happened when parsing window location"),e[1]+"/ocsms"+t},selectConversation:function(t){"undefined"!==t&&null!=t&&(null!=this.selectedConversation&&this.selectedConversation.parent().removeClass("selected"),this.selectedConversation=t,this.selectedConversation.parent().addClass("selected"),this.selectedConversation.css("font-weight","normal"),this.selectedConversation.html(this.selectedConversation.attr("mailbox-label")))}},ContactRenderer={generateColor:function(t){if(void 0===t)return"";if("function"==typeof t.toHsl){var e=t.toHsl();return"hsl("+e[0]+", "+e[1]+"%, "+e[2]+"%)"}for(var n=0,a=String(t),o=0;o<a.length;o++)n=a.charCodeAt(o)+((n<<5)-n);return"hsl("+Math.abs(n)%360+", 70%, 60%)"},generateFirstCharacter:function(t){return"string"!=typeof t?"?":"+"===t.charAt(0)?"#":t.charAt(0)}};$.urlParam=function(t){var e=new RegExp("[?&]"+t+"=([^&#]*)").exec(window.location.href);return null==e?null:e[1]||0},Vue.filter("firstCharacter",ContactRenderer.generateFirstCharacter),Vue.filter("date",function(t,e){if(!t)return"";var n=t instanceof Date?t:new Date(t);if(isNaN(n.getTime()))return"";var a={};return a="medium"===e?{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}:"short"===e?{year:"2-digit",month:"numeric",day:"numeric"}:{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"},n.toLocaleString(void 0,a)});const Dialog=Vue.extend({template:"#modal-template"});Vue.directive("confirm",{bind(t,e,n){const a=e.value[1],o=e.value[0];t.handleClick=(t=>{const e={doYes:function(){a(),e.show=!1},show:!0,bodyMessage:o};let n=new Dialog({data:e}).$mount();document.getElementById("app").appendChild(n.$el)}),t.addEventListener("click",t.handleClick)},unbind(t){t.removeEventListener("click",t.handleClick)}}),jQuery,OC,window.onfocus=function(){Sms.unreadCountCurrentConv=0,document.title=Sms.originalTitle};var SmsSettings=new Vue({el:"#app-settings",data:{messageLimit:100,enableNotifications:!0,contactOrderBy:"lastmsg",reverseContactOrder:!0,country:""},created:function(){var t=this;$.getJSON(Sms.generateURL("/front-api/v1/settings"),function(e,n){!0===e.status&&(t.messageLimit=parseInt(e.message_limit),t.enableNotifications=0!==parseInt(e.notification_state)?1:0,t.contactOrderBy=e.contact_order,t.reverseContactOrder=toBool(e.contact_order_reverse),t.country=e.country)})},methods:{sendMessageLimit:function(){if(null!==this.messageLimit){$.post(Sms.generateURL("/set/msglimit"),{limit:this.messageLimit})}},sendNotificationFlag:function(){$.post(Sms.generateURL("/set/notification_state"),{notification:parseInt(this.enableNotifications)})},sendContactOrder:function(){$.post(Sms.generateURL("/set/contact_order"),{attribute:this.contactOrderBy,reverse:this.reverseContactOrder})},sendCountry:function(){$.post(Sms.generateURL("/set/country"),{country:this.country})},wipeAllMessages:function(){$.post(Sms.generateURL("/front-api/v1/delete/all"),{},function(){ContactList.reset(),Conversation.clear()})},isContactListEmpty:function(){return 0===ContactList.contacts.length}}}),ContactList=new Vue({el:"#app-mailbox-peers",data:{isContactsLoading:!0,contacts:[],lastRetrievedMessageDate:0,totalUnreadMessages:0,lastTotalUnreadCount:0},created:function(){this.reset(),this.fetch(),this.checkNewMessages(),setInterval(this.checkNewMessages,1e4)},methods:{reset:function(){this.contacts=[],this.lastRetrievedMessageDate=0,this.totalUnreadMessages=0,this.lastTotalUnreadCount=0},fetch:function(){let t=this;$.getJSON(Sms.generateURL("/front-api/v1/peerlist"),function(e,n){let a=[];Sms.photoVersion=e.photo_version,$.each(e.phonelist,function(n,o){var s;if(!inArray(s=void 0===e.contacts[n]?n:e.contacts[n],a)){var i={label:s,nav:n,unread:0,lastmsg:parseInt(o)};void 0!==e.photos[s]&&(i.avatar=e.photos[s]),void 0!==e.uids[s]?i.uid=e.uids[s]:i.uid=s,t.addContact(i),a.push(s)}}),t.isContactsLoading=!1,Sms.lastContactListMsgDate=e.lastRead,t.lastRetrievedMessageDate=e.lastMessage;var o=$.urlParam("phonenumber");if(null!=o){var s=decodeURIComponent(o);if(null!=s){if(void 0===Conversation.selectedContact.nav){Conversation.selectedContact.label=s,Conversation.selectedContact.nav=s,Conversation.selectedContact.avatar=void 0;for(var i=0;i<t.contacts.length;i++)if(t.contacts[i].nav===s){Conversation.selectedContact=t.contacts[i];break}}Conversation.fetch(Conversation.selectedContact),Sms.selectConversation($("a[mailbox-navigation='"+s+"']"))}}})},getContactColor:function(t){return ContactRenderer.generateColor(t)},loadConversation:function(t){OC.Util.History.pushState("phonenumber="+t.nav),null!==t.nav&&(Conversation.fetch(t),Sms.selectConversation($("a[mailbox-navigation='"+t.nav+"']")))},addContact:function(t){this.contacts.push(t)},removeContact:function(t){for(var e=this.contacts.length,n=0;n<e;n++){if(this.contacts[n].nav===t.nav)return void this.contacts.splice(n,1)}},modifyContact:function(t){for(var e=this.contacts.length,n=0;n<e;n++)this.contacts[n].nav===t.nav&&(this.contacts[n].unread=parseInt(t.unread),void 0!==t.avatar&&(this.contacts[n].avatar=t.avatar))},checkNewMessages:function(){this.totalUnreadMessages=0;var t=this;$.getJSON(Sms.generateURL("/front-api/v1/new_messages"),{lastDate:this.lastRetrievedMessageDate},function(e,n){let a=[];$.each(e.phonelist,function(n,o){let s,i;if(!inArray(i=void 0===e.contacts[n]?n:s=e.contacts[n],a)){let s={label:i,nav:n,unread:parseInt(o)};void 0!==e.photos[i]&&(s.avatar=e.photos[i]),void 0!==e.uids[i]?s.uid=e.uids[i]:s.uid=i,ContactList.modifyContact(s),a.push(i),n===Conversation.selectedContact.nav&&Sms.selectConversation($("a[mailbox-navigation='"+n+"']")),t.totalUnreadMessages+=parseInt(o)}}),Sms.unreadCountNotifStep>0&&Sms.unreadCountNotifStep--,t.totalUnreadMessages>0&&(0!==Sms.unreadCountNotifStep&&t.lastTotalUnreadCount===t.totalUnreadMessages||(SmsNotifications.notify(t.totalUnreadMessages+" unread message(s) for all conversations"),Sms.unreadCountNotifStep=12,t.lastTotalUnreadCount=t.totalUnreadMessages))})}},computed:{orderedContacts:function(){return _.orderBy(this.contacts,[SmsSettings.contactOrderBy],[SmsSettings.reverseContactOrder?"desc":"asc"])}}}),Conversation=new Vue({el:"#app-content",data:{selectedContact:{},isConvLoading:!1,messages:[],lastConvMessageDate:0,totalMessageCount:0,refreshIntervalId:null},methods:{fetch:function(t){null!=t&&(this.selectedContact=t,this.isConvLoading=!0),this.messages=[],this.lastConvMessageDate=0;let e=this;$.getJSON(Sms.generateURL("/front-api/v1/conversation"),{phoneNumber:e.selectedContact.nav},function(t,n){let a=e.selectedContact.nav;if(void 0!==t.phoneNumbers){a=arrayUnique(t.phoneNumbers).toString()}e.formatConversation(t),void 0===t.contactName||""===t.contactName?(e.selectedContact.label=a,e.selectedContact.opt_numbers=""):(e.selectedContact.label=t.contactName,e.selectedContact.opt_numbers=a),e.totalMessageCount=void 0!==t.msgCount?t.msgCount:0,e.isConvLoading=!1,$("#app-content").scrollTop(1e10),null!==e.refreshIntervalId&&clearInterval(e.refreshIntervalId),e.refreshIntervalId=setInterval(e.refresh,1e4)})},refresh:function(){var t=this;$.getJSON(Sms.generateURL("/front-api/v1/conversation"),{phoneNumber:Conversation.selectedContact.nav,lastDate:Conversation.lastConvMessageDate},function(e,n){var a=t.formatConversation(e);!0===a[1]&&($("#app-content").scrollTop(1e10),!1===document.hasFocus()&&(Sms.unreadCountCurrentConv+=parseInt(a[0]),document.title=Sms.originalTitle+" ("+Sms.unreadCountCurrentConv+")",SmsNotifications.notify(Sms.unreadCountCurrentConv+" unread message(s) in conversation with "+Conversation.selectedContact.label))),t.totalMessageCount=void 0!==e.msgCount?parseInt(e.msgCount):0})},getContactColor:function(t){return ContactRenderer.generateColor(t)},formatConversation:function(t){let e=!1,n="",a=0,o=this,s={base:OC.generateUrl("/apps/ocsms/js/twemoji/")};return $.each(t.conversation,function(t,i){n=1==i.type?"recv":2==i.type?"sent":"unknown",t/100>o.lastConvMessageDate/100&&(o.lastConvMessageDate=t,o.addConversationMessage({id:t,type:n,date:new Date(1*t),content:twemoji.parse(anchorme(escapeHTML(i.msg)),s)}),e=!0,a++)}),[a,e]},addConversationMessage:function(t){this.messages.push(t)},removeConversationMessage:function(t){const e=this.messages.length;let n=this;for(var a=0;a<e;a++){if(this.messages[a].id===t)return void $.post(Sms.generateURL("/delete/message"),{messageId:t,phoneNumber:this.selectedContact.label},function(t){n.messages.splice(a,1),0===n.messages.length&&n.clear()})}},removeConversation:function(){var t=this;$.post(Sms.generateURL("/delete/conversation"),{contact:t.selectedContact.label},function(e){t.clear()})},clear:function(){this.selectedContact.label="",this.selectedContact.opt_numbers="",this.selectedContact.avatar=void 0,ContactList.removeContact(this.selectedContact),this.messages=[],this.selectedContact={},OC.Util.History.pushState(""),clearInterval(this.refreshIntervalId),this.refreshIntervalId=null}},computed:{orderedMessages:function(){return _.orderBy(this.messages,["date"],["desc"])}}});function inArray(t,e){return-1!==$.inArray(t,e)}function arrayUnique(t){return t.filter(function(t,e,n){return e===n.indexOf(t)})}function toBool(t){return"true"===t||"false"!==t&&null}function escapeHTML(t){var e,n=""+t,a=/["'&<>]/.exec(n);if(!a)return n;var o="",s=0,i=0;for(s=a.index;s<n.length;s++){switch(n.charCodeAt(s)){case 34:e="&quot;";break;case 38:e="&amp;";break;case 39:e="&#39;";break;case 60:e="&lt;";break;case 62:e="&gt;";break;default:continue}i!==s&&(o+=n.substring(i,s)),i=s+1,o+=e}return i!==s?o+n.substring(i,s):o}var SmsNotifications={init:function(){"Notification"in window&&Notification.requestPermission(function(t){"permission"in Notification||(Notification.permission=t)})},notify:function(t){SmsSettings.enableNotifications&&"Notification"in window&&("granted"===Notification.permission?new Notification("Phone Sync - "+t):"denied"!==Notification.permission&&Notification.requestPermission(function(e){"permission"in Notification||(Notification.permission=e),"granted"===e&&new Notification("Phone Sync - "+t)}))}};