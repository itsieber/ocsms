var Sms={selectedConversation:null,unreadCountCurrentConv:0,unreadCountNotifStep:12,lastContactListMsgDate:0,originalTitle:document.title,photoVersion:1,_winRegexp:/(.*)\/ocsms.*/,generateURL:function(e){var t=this._winRegexp.exec(window.location.href);return 2!==t.length&&console.log("A very bad error happened when parsing window location"),t[1]+"/ocsms"+e},selectConversation:function(e){"undefined"!==e&&null!=e&&(null!=this.selectedConversation&&this.selectedConversation.parent().removeClass("selected"),this.selectedConversation=e,this.selectedConversation.parent().addClass("selected"),this.selectedConversation.css("font-weight","normal"),this.selectedConversation.html(this.selectedConversation.attr("mailbox-label")))}},ContactRenderer={generateColor:function(e){if(void 0===e)return"";if("function"==typeof e.toHsl){var t=e.toHsl();return"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)"}for(var n=0,s=String(e),a=0;a<s.length;a++)n=s.charCodeAt(a)+((n<<5)-n);return"hsl("+Math.abs(n)%360+", 70%, 60%)"},generateFirstCharacter:function(e){return"string"!=typeof e?"?":"+"===e.charAt(0)?"#":e.charAt(0)}};$.urlParam=function(e){var t=new RegExp("[?&]"+e+"=([^&#]*)").exec(window.location.href);return null==t?null:t[1]||0},Vue.filter("firstCharacter",ContactRenderer.generateFirstCharacter),Vue.filter("date",function(e,t){if(!e)return"";var n=e instanceof Date?e:new Date(e);if(isNaN(n.getTime()))return"";var s={};return s="medium"===t?{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}:"short"===t?{year:"2-digit",month:"numeric",day:"numeric"}:{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"},n.toLocaleString(void 0,s)});const Dialog=Vue.extend({template:"#modal-template"});Vue.directive("confirm",{bind(e,t,n){const s=t.value[1],a=t.value[0];e.handleClick=(e=>{const t={doYes:function(){s(),t.show=!1},show:!0,bodyMessage:a};let n=new Dialog({data:t}).$mount();document.getElementById("app").appendChild(n.$el)}),e.addEventListener("click",e.handleClick)},unbind(e){e.removeEventListener("click",e.handleClick)}}),jQuery,OC,window.onfocus=function(){Sms.unreadCountCurrentConv=0,document.title=Sms.originalTitle};var SmsSettings=new Vue({el:"#app-settings",data:{messageLimit:100,enableNotifications:!0,contactOrderBy:"lastmsg",reverseContactOrder:!0,country:""},created:function(){var e=this;$.getJSON(Sms.generateURL("/front-api/v1/settings"),function(t,n){!0===t.status&&(e.messageLimit=parseInt(t.message_limit),e.enableNotifications=0!==parseInt(t.notification_state)?1:0,e.contactOrderBy=t.contact_order,e.reverseContactOrder=toBool(t.contact_order_reverse),e.country=t.country)})},methods:{sendMessageLimit:function(){if(null!==this.messageLimit){$.post(Sms.generateURL("/set/msglimit"),{limit:this.messageLimit})}},sendNotificationFlag:function(){$.post(Sms.generateURL("/set/notification_state"),{notification:parseInt(this.enableNotifications)})},sendContactOrder:function(){$.post(Sms.generateURL("/set/contact_order"),{attribute:this.contactOrderBy,reverse:this.reverseContactOrder})},sendCountry:function(){$.post(Sms.generateURL("/set/country"),{country:this.country})},wipeAllMessages:function(){$.post(Sms.generateURL("/front-api/v1/delete/all"),{},function(){ContactList.reset(),Conversation.clear()})},isContactListEmpty:function(){return 0===ContactList.contacts.length}}}),ContactList=new Vue({el:"#app-mailbox-peers",data:{isContactsLoading:!0,contacts:[],lastRetrievedMessageDate:0,totalUnreadMessages:0,lastTotalUnreadCount:0,searchQuery:""},created:function(){this.reset(),this.fetch(),this.checkNewMessages(),setInterval(this.checkNewMessages,1e4)},methods:{reset:function(){this.contacts=[],this.lastRetrievedMessageDate=0,this.totalUnreadMessages=0,this.lastTotalUnreadCount=0},fetch:function(){let e=this;$.getJSON(Sms.generateURL("/front-api/v1/peerlist"),function(t,n){let s=[];Sms.photoVersion=t.photo_version,$.each(t.phonelist,function(n,a){var o;if(!inArray(o=void 0===t.contacts[n]?n:t.contacts[n],s)){var i={label:o,nav:n,unread:0,lastmsg:parseInt(a)};void 0!==t.photos[o]&&(i.avatar=t.photos[o]),void 0!==t.uids[o]?i.uid=t.uids[o]:i.uid=o,e.addContact(i),s.push(o)}}),e.isContactsLoading=!1,Sms.lastContactListMsgDate=t.lastRead,e.lastRetrievedMessageDate=t.lastMessage;var a=$.urlParam("phonenumber");if(null!=a){var o=decodeURIComponent(a);if(null!=o){if(void 0===Conversation.selectedContact.nav){Conversation.selectedContact.label=o,Conversation.selectedContact.nav=o,Conversation.selectedContact.avatar=void 0;for(var i=0;i<e.contacts.length;i++)if(e.contacts[i].nav===o){Conversation.selectedContact=e.contacts[i];break}}Conversation.fetch(Conversation.selectedContact),Sms.selectConversation($("a[mailbox-navigation='"+o+"']"))}}})},getContactColor:function(e){return ContactRenderer.generateColor(e)},loadConversation:function(e){OC.Util.History.pushState("phonenumber="+e.nav),null!==e.nav&&(Conversation.fetch(e),Sms.selectConversation($("a[mailbox-navigation='"+e.nav+"']")))},addContact:function(e){this.contacts.push(e)},removeContact:function(e){for(var t=this.contacts.length,n=0;n<t;n++){if(this.contacts[n].nav===e.nav)return void this.contacts.splice(n,1)}},modifyContact:function(e){for(var t=this.contacts.length,n=0;n<t;n++)this.contacts[n].nav===e.nav&&(this.contacts[n].unread=parseInt(e.unread),void 0!==e.avatar&&(this.contacts[n].avatar=e.avatar))},checkNewMessages:function(){this.totalUnreadMessages=0;var e=this;$.getJSON(Sms.generateURL("/front-api/v1/new_messages"),{lastDate:this.lastRetrievedMessageDate},function(t,n){let s=[];$.each(t.phonelist,function(n,a){let o,i;if(!inArray(i=void 0===t.contacts[n]?n:o=t.contacts[n],s)){let o={label:i,nav:n,unread:parseInt(a)};void 0!==t.photos[i]&&(o.avatar=t.photos[i]),void 0!==t.uids[i]?o.uid=t.uids[i]:o.uid=i,ContactList.modifyContact(o),s.push(i),n===Conversation.selectedContact.nav&&Sms.selectConversation($("a[mailbox-navigation='"+n+"']")),e.totalUnreadMessages+=parseInt(a)}}),Sms.unreadCountNotifStep>0&&Sms.unreadCountNotifStep--,e.totalUnreadMessages>0&&(0!==Sms.unreadCountNotifStep&&e.lastTotalUnreadCount===e.totalUnreadMessages||(SmsNotifications.notify(e.totalUnreadMessages+" unread message(s) for all conversations"),Sms.unreadCountNotifStep=12,e.lastTotalUnreadCount=e.totalUnreadMessages))})}},computed:{orderedContacts:function(){var e=this.contacts;if(this.searchQuery&&""!==this.searchQuery.trim()){var t=this.searchQuery.toLowerCase().trim();e=this.contacts.filter(function(e){var n=e.label&&-1!==e.label.toLowerCase().indexOf(t),s=e.nav&&-1!==e.nav.toLowerCase().indexOf(t);return n||s})}return _.orderBy(e,[SmsSettings.contactOrderBy],[SmsSettings.reverseContactOrder?"desc":"asc"])}}}),Conversation=new Vue({el:"#app-content",data:{selectedContact:{},isConvLoading:!1,messages:[],lastConvMessageDate:0,totalMessageCount:0,refreshIntervalId:null,newMessage:"",isSending:!1},methods:{fetch:function(e){null!=e&&(this.selectedContact=e,this.isConvLoading=!0),this.messages=[],this.lastConvMessageDate=0;let t=this;$.getJSON(Sms.generateURL("/front-api/v1/conversation"),{phoneNumber:t.selectedContact.nav},function(e,n){let s=t.selectedContact.nav;if(void 0!==e.phoneNumbers){s=arrayUnique(e.phoneNumbers).toString()}t.formatConversation(e),void 0===e.contactName||""===e.contactName?(t.selectedContact.label=s,t.selectedContact.opt_numbers=""):(t.selectedContact.label=e.contactName,t.selectedContact.opt_numbers=s),t.totalMessageCount=void 0!==e.msgCount?e.msgCount:0,t.isConvLoading=!1,$("#app-content").scrollTop(1e10),null!==t.refreshIntervalId&&clearInterval(t.refreshIntervalId),t.refreshIntervalId=setInterval(t.refresh,1e4)})},refresh:function(){var e=this;$.getJSON(Sms.generateURL("/front-api/v1/conversation"),{phoneNumber:Conversation.selectedContact.nav,lastDate:Conversation.lastConvMessageDate},function(t,n){var s=e.formatConversation(t);!0===s[1]&&($("#app-content").scrollTop(1e10),!1===document.hasFocus()&&(Sms.unreadCountCurrentConv+=parseInt(s[0]),document.title=Sms.originalTitle+" ("+Sms.unreadCountCurrentConv+")",SmsNotifications.notify(Sms.unreadCountCurrentConv+" unread message(s) in conversation with "+Conversation.selectedContact.label))),e.totalMessageCount=void 0!==t.msgCount?parseInt(t.msgCount):0})},getContactColor:function(e){return ContactRenderer.generateColor(e)},formatConversation:function(e){let t=!1,n="",s=0,a=this,o={base:OC.generateUrl("/apps/ocsms/js/twemoji/")};return $.each(e.conversation,function(e,i){n=1==i.type?"recv":2==i.type?"sent":"unknown",e/100>a.lastConvMessageDate/100&&(a.lastConvMessageDate=e,a.addConversationMessage({id:e,type:n,date:new Date(1*e),content:twemoji.parse(anchorme(escapeHTML(i.msg)),o)}),t=!0,s++)}),[s,t]},addConversationMessage:function(e){this.messages.push(e)},removeConversationMessage:function(e){const t=this.messages.length;let n=this;for(var s=0;s<t;s++){if(this.messages[s].id===e)return void $.post(Sms.generateURL("/delete/message"),{messageId:e,phoneNumber:this.selectedContact.label},function(e){n.messages.splice(s,1),0===n.messages.length&&n.clear()})}},removeConversation:function(){var e=this;$.post(Sms.generateURL("/delete/conversation"),{contact:e.selectedContact.label},function(t){e.clear()})},clear:function(){this.selectedContact.label="",this.selectedContact.opt_numbers="",this.selectedContact.avatar=void 0,ContactList.removeContact(this.selectedContact),this.messages=[],this.selectedContact={},this.newMessage="",OC.Util.History.pushState(""),clearInterval(this.refreshIntervalId),this.refreshIntervalId=null},sendMessage:function(){var e=this,t=this.newMessage.trim();if(""!==t&&!this.isSending){var n=this.selectedContact.nav;if(n){this.isSending=!0;var s=t;$.post(Sms.generateURL("/front-api/v1/send"),{phoneNumber:n,message:t},function(t){if(e.isSending=!1,"ok"===t.status){e.newMessage="";var n=Date.now(),a={base:OC.generateUrl("/apps/ocsms/js/twemoji/")};e.addConversationMessage({id:n,type:"sent",date:new Date(n),content:twemoji.parse(anchorme(escapeHTML(s)),a),pending:!0}),e.totalMessageCount++,$("#app-content").scrollTop(0)}}).fail(function(){e.isSending=!1})}}}},computed:{orderedMessages:function(){return _.orderBy(this.messages,["date"],["desc"])}}});function inArray(e,t){return-1!==$.inArray(e,t)}function arrayUnique(e){return e.filter(function(e,t,n){return t===n.indexOf(e)})}function toBool(e){return"true"===e||"false"!==e&&null}function escapeHTML(e){var t,n=""+e,s=/["'&<>]/.exec(n);if(!s)return n;var a="",o=0,i=0;for(o=s.index;o<n.length;o++){switch(n.charCodeAt(o)){case 34:t="&quot;";break;case 38:t="&amp;";break;case 39:t="&#39;";break;case 60:t="&lt;";break;case 62:t="&gt;";break;default:continue}i!==o&&(a+=n.substring(i,o)),i=o+1,a+=t}return i!==o?a+n.substring(i,o):a}var SmsNotifications={init:function(){"Notification"in window&&Notification.requestPermission(function(e){"permission"in Notification||(Notification.permission=e)})},notify:function(e){SmsSettings.enableNotifications&&"Notification"in window&&("granted"===Notification.permission?new Notification("Phone Sync - "+e):"denied"!==Notification.permission&&Notification.requestPermission(function(t){"permission"in Notification||(Notification.permission=t),"granted"===t&&new Notification("Phone Sync - "+e)}))}};